<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>testhtml: Testing that generated HTMLs change only as intended</title>
    <link rel=stylesheet href="../heapindex.css" type="text/css">
  </head>
  <body>
    <h1 id="header">testhtml: Testing that generated HTMLs change only as intended</h1>


<div class="postbox"><!-- post hh/1071 -->
<span class="postsummary" id="post_hh/1071">
<span class="author">Csaba Hoch</span>
<span class="subject">testhtml: Testing that generated HTMLs change only as intended</span>
<span class="tags">[hk-dev-utils]</span>
<span class="index"><a href="../hh/thread_1071.html#post_hh/1071">&lt;hh/1071&gt;</a></span>
<span class="parent">&lt;root&gt;</span>
<span class="date">(2010-01-30)</span>
<div class="body">
<pre class="postbody">I created a Python script called `testhtml` and pushed it to
hk-dev-utils. It executes different versions of Heapkeeper and
compares the HTML pages generated by them.

Example:

Executing testhtml with three commits, and asking it to use my hkrc
(the `time` command is deliberately included):

    $ time hk-dev-utils/testhtml f01015204f77 e6bd6c8b61a70d7 a48c38dc3e0568 \
                                 -a "--hkrc hkrc_csabahoch"
    Commits:  ['f010152', 'e6bd6c8', 'a48c38d']
    Previous HEAD position was fd4b815... Generator.walk_exp_post: bug fixed
    HEAD is now at f010152... hkshell: tidying
    Warning: HTML directory does not exists: "testhtml_results/f010152/html"
    HTML directory has been created.
    Importing hkrc_csabahoch...
    Importing hkrc_csabahoch OK
    Generating issues_all.html...
    Generating issues_sorted.html...
    Generating index.html...
    Generating thread pages...
    Previous HEAD position was f010152... hkshell: tidying
    HEAD is now at e6bd6c8... hkgen: thread link removed
    Warning: HTML directory does not exists: "testhtml_results/e6bd6c8/html"
    HTML directory has been created.
    Importing hkrc_csabahoch...
    Importing hkrc_csabahoch OK
    Generating issues_all.html...
    Generating issues_sorted.html...
    Generating index.html...
    Generating thread pages...
    Previous HEAD position was e6bd6c8... hkgen: thread link removed
    HEAD is now at a48c38d... doc/tutorial: mostly updated to 0.4
    Warning: HTML directory does not exists: "testhtml_results/a48c38d/html"
    HTML directory has been created.
    Importing hkrc_csabahoch...
    Importing hkrc_csabahoch OK
    Generating issues_all.html...
    Generating issues_sorted.html...
    Generating index.html...
    Generating thread pages...

    real    0m48.041s
    user    0m21.930s
    sys     0m3.280s

The results are in the 'testhtml_results' directory:

    hk$ cd testhtml_results/
    $ ls
    a48c38d  diffs  e6bd6c8  f010152

The 'diffs' directory contains the diff, the other directories contain
the HTML files. In the diffs directory, there is one file for each
diff:

    $ cd diffs
    $ ls
    00_f010152_e6bd6c8  01_e6bd6c8_a48c38d

The name of the file is an index number so the files will show up in
the same order as they were specified by the user.

Now let's have a look at the diffs:

    $ head 00_f010152_e6bd6c8
    diff -ur testhtml_results/f010152/html/index.html testhtml_results/e6bd6c8/html/index.html
    --- testhtml_results/f010152/html/index.html    2010-01-30 18:47:05.000000000 +0100
    +++ testhtml_results/e6bd6c8/html/index.html    2010-01-30 18:47:20.000000000 +0100
    @@ -12,7 +12,6 @@
     &lt;span class="postsummary" id="post_3869"&gt;
     &lt;span class="author"&gt;Csabi&lt;/span&gt;
     &lt;span class="subject"&gt;Email parsing problem&lt;/span&gt;
    -&lt;span class="button"&gt;&lt;a href="thread_3869.html"&gt;&lt;img src="thread.png" /&gt;&lt;/a&gt;&lt;/span&gt;
     &lt;span class="tags"&gt;[issue]&lt;/span&gt;
     &lt;span class="index"&gt;&lt;a href="thread_3869.html#post_3869"&gt;&amp;lt;3869&amp;gt;&lt;/a&gt;&lt;/span&gt;

It seems that in e6bd6c8, we removed the threadlink from the HTMLs.

Let's have a look at the other diff:

    $ head 01_e6bd6c8_a48c38d
    $

It shows that we haven't modified HTML generation in a48c38d.

I plan to execute the testhtml script on every commit that I push,
because it would catch some bugs. For example I accidentally broke
the issue tracker when I removed the old Generator. I pushed it a few
days ago and realized it only today. (Since then I rebased it :) )

When I was writing the new Generator, I made such diffs manually to
see how I change HTML generation, but it is nicer to have a script
that performs the diff of the given versions.

It accepts only SHA1 ids as commit messages. It would be nice if it
accepted any commit id (e.g. HEAD), but that's a job for someone else :)
</pre></div>
</span><!-- postsummary -->

<div class="postbox"><!-- post hh/1072 -->
<span class="postsummary" id="post_hh/1072">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_1071.html#post_hh/1072">&lt;hh/1072&gt;</a></span>
<span class="parent"><a href="../hh/thread_1071.html#post_hh/1071">&lt;&uarr;hh/1071&gt;</a></span>
<span class="date">(2010-01-31)</span>
<div class="body">
<pre class="postbody">I removed the hardwired heap directory path from the script, made
it a parameter, and pushed the modification.

I also wrote a wrapper that executes several tests in parallel:

    #!/bin/bash

    # Executes `testhtml` with different hkrcs.
    #
    # Parameters: the commits to be examined.

    # Executes a test on a series of commits on one heap directory and one setup.
    #
    # $1: name
    # $2: heap dir
    # $3..: commits
    function do_test
    {
        name=$1
        shift 1

        mkdir $name
        cd $name

        # $Hk is /a/cp/hk/hk
        git clone $Hk
        cd hk

        $Hk/hk-dev-utils/testhtml "$@"
    }

    # Temporary directory to work in
    DIR=/a/cp/hk/clones/testhtml_sandbox_1

    # Heap directories
    ums_heap_dir=/a/cp/hk/heaps/ums_posts
    sandbox_heap_dir=/a/cp/hk/heaps/sandbox_posts

    # Making sure $DIR is clear
    rm -rf $DIR
    mkdir $DIR
    cd $DIR

    # Execute different test setups in parallel (they have different working
    # directories)
    do_test pure $ums_heap_dir "$@" &amp;
    do_test csabahoch $ums_heap_dir -a "--hkrc hkrc_csabahoch" "$@" &amp;
    do_test attis $ums_heap_dir -a "--hkrc hkrc_attis" "$@" &amp;
    do_test sandbox_pure $sandbox_heap_dir "$@" &amp;
    do_test sandbox_csabahoch -a "--hkrc hkrc_csabahoch" "$@" &amp;

    # Wait for the processes to finish
    wait

    # Make a sound
    SOUND

    # Open the created diff files
    vim */hk/testhtml_results/diffs/*

It took 3:05 minutes to run the tests on three commits. When I removed
the parallel execution, it took 3:20 minutes. So making it parallel
does not help a lot.

A merit of this wrapper is that it clones the repository to a
temporary directory and works there, so the Heapkeeper developer can
continue the work without having to wait for the tests to finish.
</pre></div>
</span><!-- postsummary -->

<div class="postbox"><!-- post hh/1141 -->
<span class="postsummary" id="post_hh/1141">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_1071.html#post_hh/1141">&lt;hh/1141&gt;</a></span>
<span class="parent"><a href="../hh/thread_1071.html#post_hh/1072">&lt;&uarr;hh/1072&gt;</a></span>
<span class="date">(2010-02-10)</span>
<div class="body">
<pre class="postbody"><span class="quote"><span class="quote-1">&gt; A merit of this wrapper is that it clones the repository to a
&gt; temporary directory and works there, so the Heapkeeper developer can
&gt; continue the work without having to wait for the tests to finish.

</span></span>We're getting closer to a setting up a continuous integration server
every day :)
</pre></div>
</span><!-- postsummary -->
</div><!-- postbox for post hh/1141 -->
</div><!-- postbox for post hh/1072 -->

<div class="postbox"><!-- post hh/1140 -->
<span class="postsummary" id="post_hh/1140">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_1071.html#post_hh/1140">&lt;hh/1140&gt;</a></span>
<span class="parent"><a href="../hh/thread_1071.html#post_hh/1071">&lt;&uarr;hh/1071&gt;</a></span>
<span class="date">(2010-02-10)</span>
<div class="body">
<pre class="postbody"><span class="quote"><span class="quote-1">&gt; I created a Python script called `testhtml` and pushed it to
&gt; hk-dev-utils. It executes different versions of Heapkeeper and
&gt; compares the HTML pages generated by them.

</span></span>Great idea!

<span class="quote"><span class="quote-1">&gt; I plan to execute the testhtml script on every commit that I push,

</span></span>Sounds like a lot of work. Wouldn't it suffice to compare only with
the previous commit?

<span class="quote"><span class="quote-1">&gt; It accepts only SHA1 ids as commit messages. It would be nice if it
&gt; accepted any commit id (e.g. HEAD), but that's a job for someone else :)

</span></span>It's easy: `git rev-parse` does exactly that: you give it a revspec,
it prints the hash, like this:

    $ git rev-parse HEAD^^^
    1a2b3c4d...
</pre></div>
</span><!-- postsummary -->

<div class="postbox"><!-- post hh/1142 -->
<span class="postsummary" id="post_hh/1142">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_1071.html#post_hh/1142">&lt;hh/1142&gt;</a></span>
<span class="parent"><a href="../hh/thread_1071.html#post_hh/1140">&lt;&uarr;hh/1140&gt;</a></span>
<span class="date">(2010-02-10)</span>
<div class="body">
<pre class="postbody"><span class="quote"><span class="quote-2">&gt;&gt; I plan to execute the testhtml script on every commit that I push,
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; Sounds like a lot of work. Wouldn't it suffice to compare only with
&gt; the previous commit?

</span></span>I don't understand what you are saying. I compare every commit to its parent.

<span class="quote"><span class="quote-2">&gt;&gt; It accepts only SHA1 ids as commit messages. It would be nice if it
&gt;&gt; accepted any commit id (e.g. HEAD), but that's a job for someone else :)
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; It's easy: `git rev-parse` does exactly that: you give it a revspec,
&gt; it prints the hash, like this:
&gt;
&gt;    $ git rev-parse HEAD^^^
&gt;    1a2b3c4d...

</span></span>Thanks, I should use this.
</pre></div>
</span><!-- postsummary -->

<div class="postbox"><!-- post hh/1143 -->
<span class="postsummary" id="post_hh/1143">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_1071.html#post_hh/1143">&lt;hh/1143&gt;</a></span>
<span class="parent"><a href="../hh/thread_1071.html#post_hh/1142">&lt;&uarr;hh/1142&gt;</a></span>
<span class="date">(2010-02-11)</span>
<div class="body">
<pre class="postbody"><span class="quote"><span class="quote-2">&gt;&gt; Sounds like a lot of work. Wouldn't it suffice to compare only with
&gt;&gt; the previous commit?
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; I don't understand what you are saying. I compare every commit to its parent.

</span></span>I noted this because you demonstrated comparing 3 commits. Maybe the
script could have been simpler if it only compared two. But since you
already implemented it, it doesn't matter :)
</pre></div>
</span><!-- postsummary -->

<div class="postbox"><!-- post hh/1144 -->
<span class="postsummary" id="post_hh/1144">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_1071.html#post_hh/1144">&lt;hh/1144&gt;</a></span>
<span class="parent"><a href="../hh/thread_1071.html#post_hh/1143">&lt;&uarr;hh/1143&gt;</a></span>
<span class="date">(2010-02-11)</span>
<div class="body">
<pre class="postbody"><span class="quote"><span class="quote-3">&gt;&gt;&gt; Sounds like a lot of work. Wouldn't it suffice to compare only with
&gt;&gt;&gt; the previous commit?
</span></span><span class="quote"><span class="quote-2">&gt;&gt;
&gt;&gt; I don't understand what you are saying. I compare every commit to its parent.
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; I noted this because you demonstrated comparing 3 commits. Maybe the
&gt; script could have been simpler if it only compared two. But since you
&gt; already implemented it, it doesn't matter :)

</span></span>I think you don't understand what the script does. It is designed to
compare a *sequence* of commits. Each commit in the sequence should be
the child of the previous one. The script compares each commit in the
sequence to the previous commit, so if you use it right, you will
always compare a parent commit to a child commit.

If you run the script twice, the second execution will delete the
result of the previous one. Thus it was not OK to implement getting
only two commits and compare those, and let the users call the script
multiple times if they have more than 2 commits to compare.

For me, it is a very common workflow that I create a sequence of
commits, and then I decide to push all of them. This script can go
through that sequence and check each commit against its parent.
</pre></div>
</span><!-- postsummary -->

<div class="postbox"><!-- post hh/1145 -->
<span class="postsummary" id="post_hh/1145">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_1071.html#post_hh/1145">&lt;hh/1145&gt;</a></span>
<span class="parent"><a href="../hh/thread_1071.html#post_hh/1144">&lt;&uarr;hh/1144&gt;</a></span>
<span class="date">(2010-02-11)</span>
<div class="body">
<pre class="postbody"><span class="quote"><span class="quote-1">&gt; For me, it is a very common workflow that I create a sequence of
&gt; commits, and then I decide to push all of them. This script can go
&gt; through that sequence and check each commit against its parent.

</span></span>Ah, I see. That explains why the n-way comparison is useful.
</pre></div>
</span><!-- postsummary -->
</div><!-- postbox for post hh/1145 -->
</div><!-- postbox for post hh/1144 -->
</div><!-- postbox for post hh/1143 -->
</div><!-- postbox for post hh/1142 -->
</div><!-- postbox for post hh/1140 -->
</div><!-- postbox for post hh/1071 -->

  </body>
</html>
