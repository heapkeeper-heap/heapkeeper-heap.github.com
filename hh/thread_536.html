<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>Managing several heaps in Heapkeeper</title>
    <link rel="stylesheet" href="../static/css/heapindex.css" type="text/css" />
  </head>
  <body >
    <h1 id="header">Managing several heaps in Heapkeeper</h1>


<div class="post-box"><!-- post hh/536 -->
<div class="post-summary" id="post-summary-hh-536">
<span class="author">Csaba Hoch</span>
<span class="subject">Managing several heaps in Heapkeeper</span>
<span class="tags">[prop, reviewed]</span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-536">&lt;hh/536&gt;</a></span>
<span class="date">(2009-08-23)</span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-545">hh/545</a>,&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1188">hh/1188</a></span>
<pre class="post-body-content">This is a proposal on the design of supporting multiple heaps in
Heapkeeper.

== Idea ==

The main idea is that we will have only one PostDB object for all
posts, and the identifiers of the posts will have two components: the
name of their heap and their identifier inside that heap.

The name of the heap will be a string. The identifier of posts inside
the heap would be similar to what we now call "heapid". I would rather
call it "post name". "heapid" would confuse users, who would think
that it identifies the heap. I would call the pair of heap name and
post name "post id": that would be an unambiguous identifier of a
post, even across heaps. If you know better name than "post name", I
would be glad to hear it.

== Example: moving a post ==

This way moving the post will be easy:
- The postdb.postid_to_post dictionary will be updated, so that the
  post is assigned to the (newheap,newpostname) key. `newheap` is the
  name of the heap where the post is moved to; `newpostname` is a post
  name that is free on that heap. (This dictionary will play the role
  that is played now by PostDB.heapid_to_post.)
- The _postid data attributes of original post will be set to the new
  values.
- A new, deleted post should be created to occupy the old postid of
  the post (in the old heap, of course).
- All references in the other posts to post id of the moved post have
  to be modified so that they point to the new post id. (The
  references to its message id does not have to be changed.)

When the user saves the post database, the followings will happen:
- The new, deleted post will overwrite the old post file of the moved
  post, as if the original post was deleted.
- The original, moved post will create a new post file in the
  directory of the "new" heap.

== Current heap ==

The only problem is the inconvenience of users who want to handle one
heap and does not want to specify the name of the heap all the time.

<span class="raw-block">    &gt;&gt;&gt; p(('ums', 0))    # the first post of UMS
    &gt;&gt;&gt; p(('hh', 0))     # the first post of HH
</span>
We should have a current heap:

<span class="raw-block">    &gt;&gt;&gt; select('ums')
    &gt;&gt;&gt; p(0)             # the first post of UMS
    &gt;&gt;&gt; select('hh')
    &gt;&gt;&gt; p(0)             # the first post of HH
</span>
The only thing I don't know whether it should be better to have a
current heap in hkshell or in PostDB. It seems to me that having it in
hkshell would be architecturally cleaner, but having it in PostDB
would be a bit easier. Maybe I'll try to implement it in hkshell, and
if it turns out to be inconvenient, I'll go with having it in PostDB.
Opinions?

== Changes ==

Things that would change in order to support multiple heaps:
- Post:
    - will have `_postid` data attribute and a heap() method instead
      of `_heapid` and heapid()
    - will have a move(heap) method
    - `postfilename`, `htmlfilename`, etc. methods will be modified
- PostDB:
    - will read from several directories
    - will use post id instead of heap id everywhere
    - heaps (=sets of posts in one heap) will be lazy data attributes:
      PostDB will have a heap(heapname) method
- Server:
    - the `dl` method will have an argument to specify which heap to
      download emails from
- Generator:
    - It will write HTML files into one directory, but with heap names
      as subdirectories. An example:

<span class="raw-block">        all.html
        ums.html
        hh_issues.html
        hh_other.html
        hh/1.post
        hh/2.post
        hh/3.post
        ums/1.post
        ums/2.post
</span>
- hkshell:
    - will have a "current heap"
- hk.cfg:
    - will have a section for each heap (see also in my other email)
- post files:
    - will use post ids instead of heap ids in the "Parent" attribute
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/545 -->
<div class="post-summary" id="post-summary-hh-545">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-545">&lt;hh/545&gt;</a></span>
<span class="date">(2009-08-28)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-536">hh/536</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-546">hh/546</a></span>
<pre class="post-body-content">== Idea ==

What you propose is a very simple and powerful approach, and I like
it. However, it seems a step away from OO.

When I studied Java, a book I read had ideas on good OO design. One of
them was "if you can think about it as an entity, make it an object;
if you can think about it as a kind of entity, make it a class".

A "heap" seems to be a kind of entity, so it should have its
corresponding class. Of course, you can create a `Heap` class acting
as an adaptor to this scheme. This class would be useful as a natural
container for actions that affect a single heap, e.g. it could mirror
`PostDB`'s methods for retrieving threads, cycles, posts in a
`PostSet`... Does not seem very useful.

=== Terminology ===

<span class="quote"><span class="quote-1">&gt; The name of the heap will be a string. The identifier of posts inside
&gt; the heap would be similar to what we now call "heapid". I would rather
&gt; call it "post name". "heapid" would confuse users, who would think
&gt; that it identifies the heap. I would call the pair of heap name and
&gt; post name "post id": that would be an unambiguous identifier of a
&gt; post, even across heaps. If you know better name than "post name", I
&gt; would be glad to hear it.
</span></span>
An example: for the post created from "&lt;postdir&gt;/ums/1234.post", the
"post name" could be "ums/1234". The part before the "/" would be
called "heapid", the part after it would be "postid". "post name"
could also be called "fullid" or "fullname" to emphasize its compound
nature.

== Storage ==

You decided to store posts of distinct heaps in different
subdirectories of the post directory. There is an alternative, namely,
storing all the post files in a single directory, naming them in a
"&lt;heapid&gt;&lt;separator&gt;&lt;postid&gt;.post" syntax, where &lt;separator&gt; is
commonly "_". This is what I would have done, simply for simplicity.

But your solution is better for these two reasons:
- it gives more liberty to heapids and postids, i.e. both can contain
  any characters permitted in filenames, including "_"; suppose one
  wants to use the subject as postid with spaces replaced with
  underscores
- some (all?) filesystems tend to manage several large directories
  better than one huge

== Example: moving a post ==

<span class="quote"><span class="quote-1">&gt; This way moving the post will be easy:
</span></span>
Moving a single post will be easy, but if you move just one, its
connections to other posts will break. Probably it'll be necessary to
include a ready-made command for moving complete threads between
heaps.

The nice thing is that most of the "Parent:" header lines use "real"
"Message-Id"s from the original e-mails. This is nice because this
way, moved messages "find each other" automatically.

== Current heap ==

<span class="quote"><span class="quote-1">&gt; The only problem is the inconvenience of users who want to handle one
&gt; heap and does not want to specify the name of the heap all the time.
</span></span>
Yes it is. I imagine many users would have only one heap, why make
their lives harder? But I have another solution in mind. How about
having the empty string, '', as a special heapid? Post files for this
heap would go into the &lt;postdir&gt; directly, and when a string is used
instead of a tuple where a postname is required, this special heapid
could be assumed.

<span class="quote"><span class="quote-1"><span class="raw-block">&gt;    &gt;&gt;&gt; p(('ums', 0))    # the first post of UMS
&gt;    &gt;&gt;&gt; p(('hh', 0))     # the first post of HH
</span></span></span><span class="quote"><span class="quote-1">&gt;
&gt; We should have a current heap:
&gt;
</span></span><span class="quote"><span class="quote-1"><span class="raw-block">&gt;    &gt;&gt;&gt; select('ums')
&gt;    &gt;&gt;&gt; p(0)             # the first post of UMS
&gt;    &gt;&gt;&gt; select('hh')
&gt;    &gt;&gt;&gt; p(0)             # the first post of HH
</span></span></span>
We could have a current heap if you'd like to. This could even be used
with the previous "unnamed heap" idea: after a `select('hh')` call, a
`p('0')` would be equivalent to `p(('ums, '0'))`, so the "default
heap" would be, by default, the unnamed heap, but a new default could
be selected by a `select()` call.

<span class="quote"><span class="quote-1">&gt; The only thing I don't know whether it should be better to have a
&gt; current heap in hkshell or in PostDB. It seems to me that having it in
&gt; hkshell would be architecturally cleaner, but having it in PostDB
&gt; would be a bit easier. Maybe I'll try to implement it in hkshell, and
&gt; if it turns out to be inconvenient, I'll go with having it in PostDB.
&gt; Opinions?
</span></span>
I'd implement it in hkshell. hklib should only see the tuples.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/546 -->
<div class="post-summary" id="post-summary-hh-546">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-546">&lt;hh/546&gt;</a></span>
<span class="date">(2009-08-28)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-545">hh/545</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-547">hh/547</a>,&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1128">hh/1128</a>,&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1172">hh/1172</a></span>
<pre class="post-body-content">== Idea ==

<span class="quote"><span class="quote-1">&gt; What you propose is a very simple and powerful approach, and I like
&gt; it. However, it seems a step away from OO.
&gt;
&gt; When I studied Java, a book I read had ideas on good OO design. One of
&gt; them was "if you can think about it as an entity, make it an object;
&gt; if you can think about it as a kind of entity, make it a class".
&gt;
&gt; A "heap" seems to be a kind of entity, so it should have its
&gt; corresponding class. Of course, you can create a `Heap` class acting
&gt; as an adaptor to this scheme. This class would be useful as a natural
&gt; container for actions that affect a single heap, e.g. it could mirror
&gt; `PostDB`'s methods for retrieving threads, cycles, posts in a
&gt; `PostSet`... Does not seem very useful.
</span></span>
When I first though about having multiple heaps, I thought about
having a Heap class. But as you say, it would be a lot of work for
nothing. It would also make moving posts, caching, lazy data
structures, etc. harder.

=== Terminology ===

<span class="quote"><span class="quote-2">&gt;&gt; The name of the heap will be a string. The identifier of posts inside
&gt;&gt; the heap would be similar to what we now call "heapid". I would rather
&gt;&gt; call it "post name". "heapid" would confuse users, who would think
&gt;&gt; that it identifies the heap. I would call the pair of heap name and
&gt;&gt; post name "post id": that would be an unambiguous identifier of a
&gt;&gt; post, even across heaps. If you know better name than "post name", I
&gt;&gt; would be glad to hear it.
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; An example: for the post created from "&lt;postdir&gt;/ums/1234.post", the
&gt; "post name" could be "ums/1234".
</span></span>
Well, it would rather be a tuple: ("ums", "1234"). It's easier to
handle tuples than manipulate strings.

<span class="quote"><span class="quote-1">&gt; The part before the "/" would be called "heapid",
</span></span>
I would call it "heap name". Do you prefer "heapid"?

<span class="quote"><span class="quote-1">&gt; the part after it would be "postid".
</span></span>
Is it "post id" or "postid"?

== Storage ==

<span class="quote"><span class="quote-1">&gt; You decided to store posts of distinct heaps in different
&gt; subdirectories of the post directory. There is an alternative, namely,
&gt; storing all the post files in a single directory, naming them in a
&gt; "&lt;heapid&gt;&lt;separator&gt;&lt;postid&gt;.post" syntax, where &lt;separator&gt; is
&gt; commonly "_". This is what I would have done, simply for simplicity.
</span></span>
The separator of my proposal is the "/" character :)

== Example: moving a post ==

<span class="quote"><span class="quote-2">&gt;&gt; This way moving the post will be easy:
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; Moving a single post will be easy, but if you move just one, its
&gt; connections to other posts will break.
</span></span>
No, they won't. In my previous post I described what steps should we
perform to prevent breaking connections. Among them I wrote:

<span class="quote"><span class="quote-2">&gt;&gt; - All references in the other posts to post id of the moved post
&gt;&gt;   have to be modified so that they point to the new post id. (The
&gt;&gt;   references to its message id does not have to be changed.)
</span></span>
That means we won't break connections if we do this.

We will of course make an `mv` command that moves any set of posts to
another heap without breaking anything.

One thing I have to emphasize though: only those connections will not
be broken that are understood by Hk. So parent-child relations won't
be, and I will implement the "Reference" post attribute soon. Body
parsing would provide us with Hk's understanding of all references
made in the body of the post. Until then, we have to find a way to
deal with those. Maybe we should have special expressions like
"post://&lt;post&gt;".

<span class="quote"><span class="quote-1">&gt; Probably it'll be necessary to include a ready-made command for
&gt; moving complete threads between heaps.
</span></span>
It won't be necessary. We should of course make an mvR command, but
only for the sake of convenience:

<span class="raw-block">    &gt;&gt;&gt; mvR(rootpost, 'other_heap')

</span><span class="quote"><span class="quote-1">&gt; The nice thing is that most of the "Parent:" header lines use "real"
&gt; "Message-Id"s from the original e-mails. This is nice because this
&gt; way, moved messages "find each other" automatically.
</span></span>
I had the temptation to give all posts a message id... But it would
not be right. (Or at least I have not find the way to do it right.)

== Current heap ==

<span class="quote"><span class="quote-1">&gt; How about having the empty string, '', as a special heapid?
</span></span>
That's a good idea.

<span class="quote"><span class="quote-1">&gt; We could have a current heap if you'd like to.
</span></span>
OK.

<span class="quote"><span class="quote-1">&gt; This could even be used with the previous "unnamed heap" idea:
&gt; after a `select('hh')` call, a `p('0')` would be equivalent to
&gt; `p(('ums, '0'))`, so the "default heap" would be, by default, the
&gt; unnamed heap, but a new default could be selected by a `select()`
&gt; call.
</span></span>
I would rather write `select('')` for that purpose :)

<span class="quote"><span class="quote-2">&gt;&gt; The only thing I don't know whether it should be better to have a
&gt;&gt; current heap in hkshell or in PostDB. [...] Opinions?
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; I'd implement it in hkshell. hklib should only see the tuples.
</span></span>
OK.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/547 -->
<div class="post-summary" id="post-summary-hh-547">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-547">&lt;hh/547&gt;</a></span>
<span class="date">(2009-08-28)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-546">hh/546</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-550">hh/550</a>,&nbsp;<a href="../hh/thread_536.html#post-summary-hh-970">hh/970</a></span>
<pre class="post-body-content">=== Terminology ===

<span class="quote"><span class="quote-2">&gt;&gt; An example: for the post created from "&lt;postdir&gt;/ums/1234.post", the
&gt;&gt; "post name" could be "ums/1234".
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; Well, it would rather be a tuple: ("ums", "1234"). It's easier to
&gt; handle tuples than manipulate strings.
</span></span>
OK.

<span class="quote"><span class="quote-2">&gt;&gt; The part before the "/" would be called "heapid",
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; I would call it "heap name". Do you prefer "heapid"?
</span></span>
I prefer "id" because the other one would have to be "postid" anyway,
in order to avoid conflict with "post name". Of course, "heapid" is
already used, but in another meaning, which could be a problem. How
about using "heap_id" to denote this new meaning, ie. the first
element of the tuple that is the "post name"?

<span class="quote"><span class="quote-2">&gt;&gt; the part after it would be "postid".
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; Is it "post id" or "postid"?
</span></span>
I think either should be acceptable in text. In code, we should of
course stick to one form. If you accept my previous comment, it should
be "post_id".

== Storage ==

<span class="quote"><span class="quote-2">&gt;&gt; You decided to store posts of distinct heaps in different
&gt;&gt; subdirectories of the post directory. There is an alternative, namely,
&gt;&gt; storing all the post files in a single directory, naming them in a
&gt;&gt; "&lt;heapid&gt;&lt;separator&gt;&lt;postid&gt;.post" syntax, where &lt;separator&gt; is
&gt;&gt; commonly "_". This is what I would have done, simply for simplicity.
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; The separator of my proposal is the "/" character :)
</span></span>
In a sense, yes. :)

== Example: moving a post ==

<span class="quote"><span class="quote-1">&gt; I had the temptation to give all posts a message id... But it would
&gt; not be right. (Or at least I have not find the way to do it right.)
</span></span>
We are both Git enthusiasts. I can't imagine you haven't had the idea
of using SHA-1 :)
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/550 -->
<div class="post-summary" id="post-summary-hh-550">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-550">&lt;hh/550&gt;</a></span>
<span class="date">(2009-08-30)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-547">hh/547</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-737">hh/737</a>,&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1126">hh/1126</a></span>
<pre class="post-body-content">=== Terminology ===

<span class="quote"><span class="quote-3">&gt;&gt;&gt; The part before the "/" would be called "heapid",
</span></span><span class="quote"><span class="quote-2">&gt;&gt;
&gt;&gt; I would call it "heap name". Do you prefer "heapid"?
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; I prefer "id" because the other one would have to be "postid"
&gt; anyway, in order to avoid conflict with "post name".
</span></span>
OK.

<span class="quote"><span class="quote-1">&gt; Of course, "heapid" is already used, but in another meaning, which
&gt; could be a problem. How about using "heap_id" to denote this new
&gt; meaning, ie. the first element of the tuple that is the "post name"?
</span></span>
OK. Then we will have heap_id, post_id and post_name in code, and
"heap id", "post id" and "post name" in text.

== Example: moving a post ==

<span class="quote"><span class="quote-2">&gt;&gt; I had the temptation to give all posts a message id... But it would
&gt;&gt; not be right. (Or at least I have not find the way to do it right.)
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; We are both Git enthusiasts. I can't imagine you haven't had the
&gt; idea of using SHA-1 :)
</span></span>
You are right, I though about it a few times. I started to write my
reply, and when I reached a few paragraphs, I decided to do it in a
separate email [1].

[1] <a href="../hh/thread_549.html#post-summary-hh-549">heap://hh/549</a>
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/737 -->
<div class="post-summary" id="post-summary-hh-737">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-737">&lt;hh/737&gt;</a></span>
<span class="date">(2009-10-21)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-550">hh/550</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-856">hh/856</a>,&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1124">hh/1124</a></span>
<pre class="post-body-content"><span class="meta-text">[effort 40]</span>
<span class="meta-text">[version 0.4]</span>
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/856 -->
<div class="post-summary" id="post-summary-hh-856">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-856">&lt;hh/856&gt;</a></span>
<span class="date">(2009-11-01)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-737">hh/737</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-858">hh/858</a></span>
<pre class="post-body-content">I will start this only after we removed the old Generator. There would
be no point in modifying the old Generator for the multiple heap
architecture.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/858 -->
<div class="post-summary" id="post-summary-hh-858">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-858">&lt;hh/858&gt;</a></span>
<span class="date">(2009-11-01)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-856">hh/856</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-859">hh/859</a></span>
<pre class="post-body-content">We discussed via IM that we can remove the old Generator once my hkrc
no longer relies on it.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/859 -->
<div class="post-summary" id="post-summary-hh-859">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-859">&lt;hh/859&gt;</a></span>
<span class="date">(2009-11-01)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-858">hh/858</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1125">hh/1125</a></span>
<pre class="post-body-content">Also, hkshell and hkcustomlib has to be modified to use the new
Generator.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/1125 -->
<div class="post-summary" id="post-summary-hh-1125">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1125">&lt;hh/1125&gt;</a></span>
<span class="date">(2010-02-10)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-859">hh/859</a></span>
<span class="container-button post-summary-button">Children:&nbsp;-</span>
<pre class="post-body-content">This has also been done.
</pre></div><!-- post-summary -->
</div><!-- postbox for post hh/1125 -->
</div><!-- postbox for post hh/859 -->
</div><!-- postbox for post hh/858 -->
</div><!-- postbox for post hh/856 -->

<div class="post-box"><!-- post hh/1124 -->
<div class="post-summary" id="post-summary-hh-1124">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1124">&lt;hh/1124&gt;</a></span>
<span class="date">(2010-02-10)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-737">hh/737</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1160">hh/1160</a></span>
<pre class="post-body-content"><span class="quote"><span class="quote-1">&gt; [effort: 40]
&gt; [version: 0.4]
</span></span>
Note 1: this has been rescheduled for 0.5.

Note 2: now that you've done it, how precise was this effort estimate?
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/1160 -->
<div class="post-summary" id="post-summary-hh-1160">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1160">&lt;hh/1160&gt;</a></span>
<span class="date">(2010-02-12)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1124">hh/1124</a></span>
<span class="container-button post-summary-button">Children:&nbsp;-</span>
<pre class="post-body-content"><span class="quote"><span class="quote-2">&gt;&gt; [effort: 40]
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; Note 2: now that you've done it, how precise was this effort estimate?
</span></span>
It was about right. It is hard to say because I did not measure
exactly how much time I spent in this feature. I measure the time
spent on Hk, but during these weeks I implemented other features,
documented undocumented code and tested untested code. Also, I'm not
100% finished yet, moving posts is yet to be done.
</pre></div><!-- post-summary -->
</div><!-- postbox for post hh/1160 -->
</div><!-- postbox for post hh/1124 -->
</div><!-- postbox for post hh/737 -->

<div class="post-box"><!-- post hh/1126 -->
<div class="post-summary" id="post-summary-hh-1126">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1126">&lt;hh/1126&gt;</a></span>
<span class="date">(2010-02-10)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-550">hh/550</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1127">hh/1127</a></span>
<pre class="post-body-content"><span class="quote"><span class="quote-2">&gt;&gt; Of course, "heapid" is already used, but in another meaning, which
&gt;&gt; could be a problem. How about using "heap_id" to denote this new
&gt;&gt; meaning, ie. the first element of the tuple that is the "post name"?
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; OK. Then we will have heap_id, post_id and post_name in code, and
&gt; "heap id", "post id" and "post name" in text.
</span></span>
<a href="../hh/thread_536.html#post-summary-hh-1035">heap://hh/1035</a> suggests that the final, implemented version does not
follow this. Am I right?
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/1127 -->
<div class="post-summary" id="post-summary-hh-1127">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1127">&lt;hh/1127&gt;</a></span>
<span class="date">(2010-02-10)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1126">hh/1126</a></span>
<span class="container-button post-summary-button">Children:&nbsp;-</span>
<pre class="post-body-content">You are right.
</pre></div><!-- post-summary -->
</div><!-- postbox for post hh/1127 -->
</div><!-- postbox for post hh/1126 -->
</div><!-- postbox for post hh/550 -->

<div class="post-box"><!-- post hh/970 -->
<div class="post-summary" id="post-summary-hh-970">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-970">&lt;hh/970&gt;</a></span>
<span class="date">(2009-11-28)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-547">hh/547</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1035">hh/1035</a></span>
<pre class="post-body-content">=== Terminology ===

<span class="quote"><span class="quote-3">&gt;&gt;&gt; An example: for the post created from "&lt;postdir&gt;/ums/1234.post", the
&gt;&gt;&gt; "post name" could be "ums/1234".
</span></span><span class="quote"><span class="quote-2">&gt;&gt;
&gt;&gt; Well, it would rather be a tuple: ("ums", "1234"). It's easier to
&gt;&gt; handle tuples than manipulate strings.
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; OK.
&gt;
</span></span><span class="quote"><span class="quote-3">&gt;&gt;&gt; The part before the "/" would be called "heapid",
&gt;&gt;&gt;
</span></span><span class="quote"><span class="quote-2">&gt;&gt; I would call it "heap name". Do you prefer "heapid"?
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; I prefer "id" because the other one would have to be "postid" anyway,
&gt; in order to avoid conflict with "post name". Of course, "heapid" is
&gt; already used, but in another meaning, which could be a problem. How
&gt; about using "heap_id" to denote this new meaning, ie. the first
&gt; element of the tuple that is the "post name"?
&gt;
</span></span><span class="quote"><span class="quote-3">&gt;&gt;&gt; the part after it would be "postid".
</span></span><span class="quote"><span class="quote-2">&gt;&gt;
&gt;&gt; Is it "post id" or "postid"?
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; I think either should be acceptable in text. In code, we should of
&gt; course stick to one form. If you accept my previous comment, it should
&gt; be "post_id".
</span></span>
We misunderstood each other on a minor thing.

My proposal (which includes your suggestion):

<span class="raw-block">    heap_id + post_name = post_id
    (e.g. ums + 13 = ums/13)
</span>
As you understood it:

<span class="raw-block">    heap_id + post_id = post_name
</span>
Now I propose a third version:

<span class="raw-block">    heap_id + post_index = post_id
</span>
It is easier to remember than the other proposals, because "index" is
just an index, but "id" is unique (otherwise it would not be an "id" :) )

The post index can be any string of course -- I hope that's not a
problem.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/1035 -->
<div class="post-summary" id="post-summary-hh-1035">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1035">&lt;hh/1035&gt;</a></span>
<span class="date">(2010-01-24)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-970">hh/970</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1123">hh/1123</a></span>
<pre class="post-body-content"><span class="quote"><span class="quote-1">&gt; Now I propose a third version:
&gt;
</span></span><span class="quote"><span class="quote-1"><span class="raw-block">&gt;    heap_id + post_index = post_id
</span></span></span>
I implemented this version of supporting several heaps and pushed it.

Moving posts is not implemented yet.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/1123 -->
<div class="post-summary" id="post-summary-hh-1123">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1123">&lt;hh/1123&gt;</a></span>
<span class="date">(2010-02-10)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1035">hh/1035</a></span>
<span class="container-button post-summary-button">Children:&nbsp;-</span>
<pre class="post-body-content"><span class="quote"><span class="quote-2">&gt;&gt; Now I propose a third version:
&gt;&gt;
</span></span><span class="quote"><span class="quote-2"><span class="raw-block">&gt;&gt;    heap_id + post_index = post_id
</span></span></span><span class="quote"><span class="quote-1">&gt;
&gt; I implemented this version of supporting several heaps and pushed it.
</span></span>
Thanks for sorting this out. I'm reading this thread now, and I
noticed my mistake in the process. I wanted to write a post to correct
it, but I can see that you've made a good job.

I like this final version a lot more than either your original
suggestion or my misunderstanded one, so after all, the
misunderstanding was a good thing.
</pre></div><!-- post-summary -->
</div><!-- postbox for post hh/1123 -->
</div><!-- postbox for post hh/1035 -->
</div><!-- postbox for post hh/970 -->
</div><!-- postbox for post hh/547 -->

<div class="post-box"><!-- post hh/1128 -->
<div class="post-summary" id="post-summary-hh-1128">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1128">&lt;hh/1128&gt;</a></span>
<span class="date">(2010-02-10)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-546">hh/546</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1164">hh/1164</a></span>
<pre class="post-body-content">== Example: moving a post ==

<span class="quote"><span class="quote-3">&gt;&gt;&gt; This way moving the post will be easy:
</span></span><span class="quote"><span class="quote-2">&gt;&gt;
&gt;&gt; Moving a single post will be easy, but if you move just one, its
&gt;&gt; connections to other posts will break.
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; No, they won't. In my previous post I described what steps should we
&gt; perform to prevent breaking connections. Among them I wrote:
&gt;
</span></span><span class="quote"><span class="quote-3">&gt;&gt;&gt; - All references in the other posts to post id of the moved post
&gt;&gt;&gt;   have to be modified so that they point to the new post id. (The
&gt;&gt;&gt;   references to its message id does not have to be changed.)
</span></span>
It's more than that. We can't take it granted that all users will have
access to all the heaps a thread may span across.

We've already discussed a similar matter in Hungarian [1]. Then,
we decided that if there's a public and a private heap, posts on the
private heap could have public parents, but not the other way around.

Moving a post from a public heap to a private one will break the thread
for those who don't have access to the private heap. We should consider if
this is a mistake or not. An example: let's say that USR has two heaps,
one which is public, the other one is private.  Sensitive matters will
be discussed on the private heap, but if the subject wanders off to
safe topics, those parts of the threads will be made public. It could
go like this:

<span class="raw-block">    &lt;pub/1&gt; Susan   New positronic brain announced!
        &lt;pub/2&gt; PR      Public reception of new positronic brain
            &lt;priv/1&gt; Susan  Robot misbehaves during press conference
                &lt;priv/2&gt; Eng.Dept.  Fix released
                    &lt;pub/5&gt; Susan       Robot is safe, error fixed
</span>
For anyone seeing only the "pub" heap, this will look like:

<span class="raw-block">    &lt;pub/1&gt; Susan   New positronic brain announced!
        &lt;pub/2&gt; PR  Public reception of new positronic brain
    &lt;pub/5&gt; Susan   Robot is safe, error fixed
</span>
Just the way it should. But what if someone takes the time to check
the headers of pub/5? They'll see that it has a parent post. Even worse,
email Message-IDs are formed like email addresses. This means that
readers of the public heap will know that this post is the child of an
invisible post that has been written by someone at
"@engineering.usrobot.com", which is the leakage of sensitive
information. This is just one problem, but I think many such
subtleties may be out there if threads contain posts from multiple
heaps.

[1] heap://ums/3737
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/1164 -->
<div class="post-summary" id="post-summary-hh-1164">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1164">&lt;hh/1164&gt;</a></span>
<span class="date">(2010-02-13)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1128">hh/1128</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1178">hh/1178</a></span>
<pre class="post-body-content"><span class="quote"><span class="quote-1">&gt; We can't take it granted that all users will have access to all the
&gt; heaps a thread may span across.
</span></span>
True.

<span class="quote"><span class="quote-1">&gt; We've already discussed a similar matter in Hungarian [1]. Then,
&gt; we decided that if there's a public and a private heap, posts on the
&gt; private heap could have public parents, but not the other way around.
</span></span>
Yes, this is a very important principle.

<span class="quote"><span class="quote-1">&gt; Moving a post from a public heap to a private one will break the thread
&gt; for those who don't have access to the private heap. We should consider if
&gt; this is a mistake or not.
</span></span>
How could it *not* be the mistake? If you move a post from a public
heap to a private one without copying all its descendants, you will
break the principle you just said.

Sometimes copying the whole thread to a private heap (which would not
break this principle but would raise other questions) could make
sense, but I think it will be a very rare situation. If a thread does
not belong to the public heap, it will just get deleted.

<span class="quote"><span class="quote-1"><span class="raw-block">&gt;     &lt;pub/1&gt; Susan   New positronic brain announced!
&gt;         &lt;pub/2&gt; PR      Public reception of new positronic brain
&gt;             &lt;priv/1&gt; Susan  Robot misbehaves during press conference
&gt;                 &lt;priv/2&gt; Eng.Dept.  Fix released
&gt;                     &lt;pub/5&gt; Susan       Robot is safe, error fixed
</span></span></span>
This example breaks the principle we just agreed upon.

<span class="quote"><span class="quote-1">&gt; But what if someone takes the time to check the headers of pub/5?
&gt; They'll see that it has a parent post. Even worse, email Message-IDs
&gt; are formed like email addresses. This means that readers of the
&gt; public heap will know that this post is the child of an invisible
&gt; post that has been written by someone at "@engineering.usrobot.com",
&gt; which is the leakage of sensitive information. This is just one
&gt; problem, but I think many such subtleties may be out there if
&gt; threads contain posts from multiple heaps.
</span></span>
Nice explanation of one reason behind the principle :)

I'm not sure whether you wanted to make a point in this post beside
spelling out this principle and the reason behind it.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/1178 -->
<div class="post-summary" id="post-summary-hh-1178">
<span class="author">Attila Nagy</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1178">&lt;hh/1178&gt;</a></span>
<span class="date">(2010-02-15)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1164">hh/1164</a></span>
<span class="container-button post-summary-button">Children:&nbsp;-</span>
<pre class="post-body-content"><span class="quote"><span class="quote-1">&gt; I'm not sure whether you wanted to make a point in this post beside
&gt; spelling out this principle and the reason behind it.
</span></span>
Umm... OK, I have to admit I'm not really sure what was on my mind
when I wrote this post. Maybe I thought if an organization doesn't
have this rule, this and similar problems could arise. Which is why we
have it.

Let's see it as what you said: an explanation of an important reason
behind this principle.

(Maybe I'll edit the Heap to look as if this were my original intention...)
</pre></div><!-- post-summary -->
</div><!-- postbox for post hh/1178 -->
</div><!-- postbox for post hh/1164 -->
</div><!-- postbox for post hh/1128 -->

<div class="post-box"><!-- post hh/1172 -->
<div class="post-summary" id="post-summary-hh-1172">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1172">&lt;hh/1172&gt;</a></span>
<span class="date">(2010-02-14)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-546">hh/546</a></span>
<span class="container-button post-summary-button">Children:&nbsp;-</span>
<pre class="post-body-content">== Current heap ==

<span class="quote"><span class="quote-2">&gt;&gt; How about having the empty string, '', as a special heapid?
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; That's a good idea.
&gt;
</span></span><span class="quote"><span class="quote-2">&gt;&gt; We could have a current heap if you'd like to.
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; OK.
&gt;
</span></span><span class="quote"><span class="quote-2">&gt;&gt; This could even be used with the previous "unnamed heap" idea:
&gt;&gt; after a `select('hh')` call, a `p('0')` would be equivalent to
&gt;&gt; `p(('ums, '0'))`, so the "default heap" would be, by default, the
&gt;&gt; unnamed heap, but a new default could be selected by a `select()`
&gt;&gt; call.
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; I would rather write `select('')` for that purpose :)
&gt;
</span></span><span class="quote"><span class="quote-3">&gt;&gt;&gt; The only thing I don't know whether it should be better to have a
&gt;&gt;&gt; current heap in hkshell or in PostDB. [...] Opinions?
</span></span><span class="quote"><span class="quote-2">&gt;&gt;
&gt;&gt; I'd implement it in hkshell. hklib should only see the tuples.
</span></span><span class="quote"><span class="quote-1">&gt;
&gt; OK.
</span></span>
That's how I implemented this:

I created a variable called hkshell.heap_id_hint_var that contains the
"current" heap. It can be set using the `set_heap_id_hint` command. We
can rename it to something shorter if you insist.

This terminology of "heap id hint" was introduced in hklib and used in
hkshell as well. The reason behind this expression is that Hk will try
to find the post no matter how it was specified, but if only the post
index is given, it will use the "heap id hint". So for example it will
find 'ums/123' or ('ums', 123) regardless of the heap id hint, but it
will find '123' only if the heap id hint is set to its container heap.

I encourage you to write hkshell.set_heap_id_hint('ums') into your
hkrc file.
</pre></div><!-- post-summary -->
</div><!-- postbox for post hh/1172 -->
</div><!-- postbox for post hh/546 -->
</div><!-- postbox for post hh/545 -->

<div class="post-box"><!-- post hh/1188 -->
<div class="post-summary" id="post-summary-hh-1188">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1188">&lt;hh/1188&gt;</a></span>
<span class="date">(2010-03-15)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-536">hh/536</a></span>
<span class="container-button post-summary-button">Children:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1194">hh/1194</a></span>
<pre class="post-body-content">I implemented handling several heaps in Heapkeeper, including moving
posts within and across heaps. It required the partial implementation
of post body parsing, since there are heap links (=post references) in
the post body that should be updated during post moving.

The only missing feature from Hk regarding handling several heaps is
that one Hk config file can contain only one IMAP account. So I'm
considering using another config file format, because this one does
not seem to be optimal for our purposes.
</pre></div><!-- post-summary -->

<div class="post-box"><!-- post hh/1194 -->
<div class="post-summary" id="post-summary-hh-1194">
<span class="author">Csaba Hoch</span>
<span class="subject"><span class="star">&mdash;</span></span>
<span class="index"><a href="../hh/thread_536.html#post-summary-hh-1194">&lt;hh/1194&gt;</a></span>
<span class="date">(2010-04-10)</span>
<span class="container-button post-summary-button">Parent:&nbsp;<a href="../hh/thread_536.html#post-summary-hh-1188">hh/1188</a></span>
<span class="container-button post-summary-button">Children:&nbsp;-</span>
<pre class="post-body-content"><span class="quote"><span class="quote-1">&gt; The only missing feature from Hk regarding handling several heaps is
&gt; that one Hk config file can contain only one IMAP account. So I'm
&gt; considering using another config file format, because this one does
&gt; not seem to be optimal for our purposes.
</span></span>
I implemented and pushed this. I kept the ini configuration format,
but I introduced (sub)subsections, so e.g. instead of "[server]" now
we can write "[heaps/hh/server]". Heapkeeper also accepts the old
configuration formats. See the tutorial for examples.

So the "several heaps" feature can be considered as implemented. (Of
course there may be place for minor tweaks.) The tutorial is fully
updated.
</pre></div><!-- post-summary -->
</div><!-- postbox for post hh/1194 -->
</div><!-- postbox for post hh/1188 -->
</div><!-- postbox for post hh/536 -->

  </body>
</html>
